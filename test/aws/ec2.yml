AWSTemplateFormatVersion: 2010-09-09
Description: >-
  A stack for testing AWSCore on EC2.

Parameters:
  MyKeyName:
    Description: The keyname associated with the instance.
    Type: String
    Default: ec2_keyfile

Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: AWSCore-EC2-Test
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref InstanceRole
  TestingEC2:
    CreationPolicy:
      ResourceSignal:
        Timeout: PT10M
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0922553b7b0369273
      # Instance must have a profile for `ec2_instance_credentials()` to succeed
      IamInstanceProfile: !Ref InstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y

          # Install julia v1.0.3
          yum install -y curl tar git
          julia_url="https://julialang-s3.julialang.org/bin/linux/x64/1.0/julia-1.0.3-linux-x86_64.tar.gz"
          julia_root=/julia

          mkdir $julia_root
          curl -s -L --retry 7 "$julia_url" | tar -C "$julia_root" -x -z --strip-components=1 -f -

          /julia/bin/julia -e 'using InteractiveUtils; versioninfo()'
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource TestingEC2

      # Allow ssh access into the instance
      SecurityGroupIds:
        - !Ref SecurityGroup
      KeyName: !Ref MyKeyName

Outputs:
  EC2Ip:
    Value: !GetAtt TestingEC2.PublicIp
